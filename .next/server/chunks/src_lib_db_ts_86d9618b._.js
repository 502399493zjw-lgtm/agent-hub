module.exports=[43793,e=>{"use strict";var t=e.i(85148),a=e.i(14747);let r=[{code:"SEAFOOD",maxUses:100,type:"super"},{code:"OPENCLAW",maxUses:100,type:"super"},{code:"AGENTHUB",maxUses:50,type:"super"}],i=a.default.join(process.cwd(),"data","hub.db"),n=null;function s(){return n||((n=new t.default(i)).pragma("journal_mode = WAL"),function(e){e.exec(`
    CREATE TABLE IF NOT EXISTS assets (
      id TEXT PRIMARY KEY, name TEXT NOT NULL, display_name TEXT NOT NULL,
      type TEXT NOT NULL CHECK(type IN ('skill','channel','plugin','trigger','config','template')),
      author_id TEXT NOT NULL DEFAULT '', author_name TEXT NOT NULL DEFAULT '', author_avatar TEXT NOT NULL DEFAULT '',
      description TEXT NOT NULL DEFAULT '', long_description TEXT NOT NULL DEFAULT '',
      version TEXT NOT NULL DEFAULT '1.0.0', downloads INTEGER NOT NULL DEFAULT 0,
      rating REAL NOT NULL DEFAULT 0, rating_count INTEGER NOT NULL DEFAULT 0,
      tags TEXT NOT NULL DEFAULT '[]', category TEXT NOT NULL DEFAULT '',
      created_at TEXT NOT NULL DEFAULT '', updated_at TEXT NOT NULL DEFAULT '',
      install_command TEXT NOT NULL DEFAULT '', readme TEXT NOT NULL DEFAULT '',
      versions TEXT NOT NULL DEFAULT '[]', dependencies TEXT NOT NULL DEFAULT '[]',
      issue_count INTEGER NOT NULL DEFAULT 0, config_subtype TEXT,
      hub_score INTEGER NOT NULL DEFAULT 70, hub_score_breakdown TEXT NOT NULL DEFAULT '{}',
      upgrade_rate REAL NOT NULL DEFAULT 50, compatibility TEXT NOT NULL DEFAULT '{}',
      files TEXT NOT NULL DEFAULT '[]'
    );
    CREATE TABLE IF NOT EXISTS users (
      id TEXT PRIMARY KEY, email TEXT UNIQUE, name TEXT NOT NULL, avatar TEXT DEFAULT '',
      provider TEXT NOT NULL, provider_id TEXT NOT NULL, bio TEXT DEFAULT '',
      invite_code TEXT, created_at TEXT NOT NULL, updated_at TEXT NOT NULL, deleted_at TEXT,
      UNIQUE(provider, provider_id)
    );
    CREATE TABLE IF NOT EXISTS invite_codes (
      code TEXT PRIMARY KEY, created_by TEXT DEFAULT 'system', used_by TEXT, used_at TEXT,
      max_uses INTEGER DEFAULT 1, use_count INTEGER DEFAULT 0, expires_at TEXT, created_at TEXT NOT NULL,
      type TEXT NOT NULL DEFAULT 'normal'
    );
    CREATE TABLE IF NOT EXISTS user_profiles (
      id TEXT PRIMARY KEY, name TEXT NOT NULL, avatar TEXT NOT NULL DEFAULT '', bio TEXT NOT NULL DEFAULT '',
      joined_at TEXT NOT NULL DEFAULT '', published_assets TEXT NOT NULL DEFAULT '[]',
      favorite_assets TEXT NOT NULL DEFAULT '[]', followers INTEGER NOT NULL DEFAULT 0,
      following INTEGER NOT NULL DEFAULT 0, is_agent BOOLEAN NOT NULL DEFAULT 0,
      agent_model TEXT, agent_uptime TEXT, agent_tasks_completed INTEGER NOT NULL DEFAULT 0,
      agent_specialization TEXT, contribution_points INTEGER NOT NULL DEFAULT 0,
      contributor_level TEXT NOT NULL DEFAULT 'newcomer', instance_id TEXT
    );
    CREATE TABLE IF NOT EXISTS comments (
      id TEXT PRIMARY KEY, asset_id TEXT NOT NULL, user_id TEXT NOT NULL,
      user_name TEXT, user_avatar TEXT, content TEXT, rating INTEGER,
      created_at TEXT, commenter_type TEXT NOT NULL DEFAULT 'user'
    );
    CREATE TABLE IF NOT EXISTS issues (
      id TEXT PRIMARY KEY, asset_id TEXT NOT NULL, author_id TEXT,
      author_name TEXT, author_avatar TEXT, author_type TEXT NOT NULL DEFAULT 'user',
      title TEXT, body TEXT, status TEXT NOT NULL DEFAULT 'open',
      labels TEXT NOT NULL DEFAULT '[]', created_at TEXT, comment_count INTEGER NOT NULL DEFAULT 0
    );
    CREATE TABLE IF NOT EXISTS collections (
      id TEXT PRIMARY KEY, title TEXT, description TEXT,
      curator_id TEXT, curator_name TEXT, curator_avatar TEXT,
      asset_ids TEXT NOT NULL DEFAULT '[]', cover_emoji TEXT,
      followers INTEGER NOT NULL DEFAULT 0, created_at TEXT
    );
    CREATE TABLE IF NOT EXISTS notifications (
      id TEXT PRIMARY KEY, user_id TEXT NOT NULL DEFAULT 'self', type TEXT,
      title TEXT, message TEXT, icon TEXT, link_to TEXT,
      is_read BOOLEAN NOT NULL DEFAULT 0, created_at TEXT
    );
    CREATE TABLE IF NOT EXISTS evolution_events (
      id TEXT PRIMARY KEY, user_id TEXT NOT NULL, icon TEXT,
      title TEXT, description TEXT, date TEXT, type TEXT
    );
    CREATE TABLE IF NOT EXISTS activity_events (
      id TEXT PRIMARY KEY, user_id TEXT NOT NULL, icon TEXT,
      text TEXT, date TEXT, type TEXT, link_to TEXT,
      actor_type TEXT NOT NULL DEFAULT 'user'
    );
    CREATE TABLE IF NOT EXISTS authorized_devices (
      device_id TEXT PRIMARY KEY,
      user_id TEXT NOT NULL,
      name TEXT NOT NULL DEFAULT '',
      authorized_at TEXT NOT NULL,
      last_publish_at TEXT,
      FOREIGN KEY (user_id) REFERENCES users(id)
    );
    CREATE TABLE IF NOT EXISTS verification_tokens (
      identifier TEXT NOT NULL,
      token TEXT NOT NULL,
      expires TEXT NOT NULL,
      PRIMARY KEY (identifier, token)
    );
    CREATE TABLE IF NOT EXISTS daily_stats (
      day INTEGER PRIMARY KEY, downloads INTEGER NOT NULL DEFAULT 0,
      new_assets INTEGER NOT NULL DEFAULT 0, new_users INTEGER NOT NULL DEFAULT 0
    );
    CREATE TABLE IF NOT EXISTS coin_events (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      user_id TEXT NOT NULL,
      coin_type TEXT NOT NULL CHECK(coin_type IN ('reputation', 'shrimp_coin')),
      amount INTEGER NOT NULL,
      event TEXT NOT NULL,
      ref_id TEXT,
      balance_after INTEGER NOT NULL DEFAULT 0,
      created_at TEXT NOT NULL
    );
    CREATE INDEX IF NOT EXISTS idx_coin_events_user ON coin_events(user_id, coin_type);
    CREATE INDEX IF NOT EXISTS idx_coin_events_ref ON coin_events(ref_id);
  `);try{e.exec("ALTER TABLE users ADD COLUMN reputation INTEGER NOT NULL DEFAULT 0")}catch{}try{e.exec("ALTER TABLE users ADD COLUMN shrimp_coins INTEGER NOT NULL DEFAULT 100")}catch{}try{e.exec("ALTER TABLE users ADD COLUMN onboarding_completed INTEGER NOT NULL DEFAULT 0")}catch{}try{e.exec("ALTER TABLE users ADD COLUMN custom_name TEXT")}catch{}try{e.exec("ALTER TABLE users ADD COLUMN custom_avatar TEXT")}catch{}try{e.exec("ALTER TABLE users ADD COLUMN provider_name TEXT")}catch{}try{e.exec("ALTER TABLE users ADD COLUMN provider_avatar TEXT")}catch{}try{e.exec("ALTER TABLE assets ADD COLUMN manifest TEXT NOT NULL DEFAULT '{}'")}catch{}if(0===e.prepare("SELECT COUNT(*) as cnt FROM invite_codes").get().cnt){let t=new Date().toISOString(),a=e.prepare("INSERT OR IGNORE INTO invite_codes (code, created_by, max_uses, use_count, type, created_at) VALUES (?, 'system', ?, 0, ?, ?)");for(let e of r)a.run(e.code,e.maxUses,e.type??"system",t)}}(n)),n}function o(e,t,a){return{hubScore:0,hubScoreBreakdown:{downloadScore:0,maintenanceScore:0,reputationScore:0}}}function d(e){let t=s(),a=t.prepare("SELECT downloads, rating, rating_count FROM assets WHERE id = ?").get(e);if(!a)return;let{hubScore:r,hubScoreBreakdown:i}=o(a.downloads,a.rating,a.rating_count);t.prepare("UPDATE assets SET hub_score = ?, hub_score_breakdown = ? WHERE id = ?").run(r,JSON.stringify(i),e)}function E(e){let t=s();if(0===t.prepare("UPDATE assets SET downloads = downloads + 1 WHERE id = ?").run(e).changes)return null;d(e);let a=t.prepare("SELECT author_id, downloads FROM assets WHERE id = ?").get(e);return a?.author_id&&(u(a.author_id,"reputation",3,"asset_installed",e),u(a.author_id,"shrimp_coin",10,"asset_installed",e)),a?.downloads??null}function u(e,t,a,r,i){let n=s(),o="reputation"===t?"reputation":"shrimp_coins",d=n.prepare(`SELECT ${o} FROM users WHERE id = ?`).get(e);if(!d)return;let E=Math.max(0,(d[o]??0)+a);n.prepare(`UPDATE users SET ${o} = ? WHERE id = ?`).run(E,e),n.prepare("INSERT INTO coin_events (user_id, coin_type, amount, event, ref_id, balance_after, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)").run(e,t,a,r,i??null,E,new Date().toISOString())}function T(e){let t=s().prepare("SELECT reputation, shrimp_coins FROM users WHERE id = ?").get(e);return{reputation:t?.reputation??0,shrimpCoins:t?.shrimp_coins??100}}function c(e,t,a=50){let r=s(),i="SELECT * FROM coin_events WHERE user_id = ?",n=[e];return t&&(i+=" AND coin_type = ?",n.push(t)),i+=" ORDER BY id DESC LIMIT ?",n.push(a),r.prepare(i).all(...n).map(e=>({id:e.id,coinType:e.coin_type,amount:e.amount,event:e.event,refId:e.ref_id,balanceAfter:e.balance_after,createdAt:e.created_at}))}function p(e){return{id:e.id,name:e.name,displayName:e.display_name,type:e.type,author:{id:e.author_id||"u-"+e.author_name.toLowerCase().replace(/\s+/g,"-"),name:e.author_name,avatar:e.author_avatar},description:e.description,longDescription:e.long_description,version:e.version,downloads:e.downloads,rating:e.rating,ratingCount:e.rating_count,tags:JSON.parse(e.tags),category:e.category,createdAt:e.created_at,updatedAt:e.updated_at,installCommand:e.install_command,readme:e.readme,versions:JSON.parse(e.versions),dependencies:JSON.parse(e.dependencies),compatibility:JSON.parse(e.compatibility),issueCount:e.issue_count,files:JSON.parse(e.files||"[]"),configSubtype:e.config_subtype??void 0,githubUrl:e.github_url||void 0,githubStars:e.github_stars||void 0,githubForks:e.github_forks||void 0}}function l(e){let t,a=s(),r=[],i={};e.type&&["skill","config","plugin","trigger","channel","template"].includes(e.type)&&(r.push("type = @type"),i.type=e.type),e.category&&(r.push("category = @category"),i.category=e.category),e.q&&(r.push("(name LIKE @q OR display_name LIKE @q OR description LIKE @q OR tags LIKE @q)"),i.q=`%${e.q}%`);let n=r.length>0?"WHERE "+r.join(" AND "):"",o=a.prepare(`SELECT COUNT(*) as cnt FROM assets ${n}`).get(i).cnt;switch(e.sort){case"downloads":t="downloads DESC";break;case"rating":t="rating DESC";break;case"updated_at":case"newest":t="updated_at DESC";break;case"created_at":t="created_at DESC";break;case"trending":t="downloads DESC, updated_at DESC";break;default:t="(downloads * rating) DESC"}let d=Math.max(1,e.page??1),E=Math.min(100,Math.max(1,e.pageSize??20));return{assets:a.prepare(`SELECT * FROM assets ${n} ORDER BY ${t} LIMIT @limit OFFSET @offset`).all({...i,limit:E,offset:(d-1)*E}).map(p),total:o,page:d,pageSize:E}}function _(e){let t=s().prepare("SELECT * FROM assets WHERE id = ?").get(e);return t?p(t):null}function L(e){let t=s(),a={skill:"s",config:"c",plugin:"p",trigger:"tr",channel:"ch",template:"t"}[e.type]||"x",r=`${a}-${Math.random().toString(36).substring(2,8)}`,i=new Date().toISOString().split("T")[0],n=e.authorName||"CyberNova",d=e.authorAvatar||"ğŸ¤–",E=e.authorId||"u-"+n.toLowerCase().replace(/\s+/g,"-"),{hubScore:T,hubScoreBreakdown:c}=o(0,0,0),p={id:r,name:e.name,displayName:e.displayName,type:e.type,author:{id:E,name:n,avatar:d},description:e.description,longDescription:e.longDescription||"",version:e.version,downloads:0,rating:0,ratingCount:0,tags:e.tags||[],category:e.category||"",createdAt:i,updatedAt:i,installCommand:`seafood-market install ${e.type}/@${E}/${e.name}`,readme:e.readme||"",versions:[{version:e.version,changelog:"é¦–æ¬¡å‘å¸ƒ",date:i}],dependencies:[],compatibility:{models:["GPT-4","Claude 3"],platforms:["OpenClaw"],frameworks:["Node.js"]},issueCount:0,configSubtype:e.configSubtype};return t.prepare("INSERT INTO assets (id,name,display_name,type,author_id,author_name,author_avatar,description,long_description,version,downloads,rating,rating_count,tags,category,created_at,updated_at,install_command,readme,versions,dependencies,issue_count,config_subtype,hub_score,hub_score_breakdown,upgrade_rate,compatibility,files) VALUES (@id,@name,@display_name,@type,@author_id,@author_name,@author_avatar,@description,@long_description,@version,@downloads,@rating,@rating_count,@tags,@category,@created_at,@updated_at,@install_command,@readme,@versions,@dependencies,@issue_count,@config_subtype,@hub_score,@hub_score_breakdown,@upgrade_rate,@compatibility,@files)").run(function(e){let{hubScore:t,hubScoreBreakdown:a}=o(e.downloads,e.rating,e.ratingCount);return{id:e.id,name:e.name,display_name:e.displayName,type:e.type,author_id:e.author.id,author_name:e.author.name,author_avatar:e.author.avatar,description:e.description,long_description:e.longDescription,version:e.version,downloads:e.downloads,rating:e.rating,rating_count:e.ratingCount,tags:JSON.stringify(e.tags),category:e.category,created_at:e.createdAt,updated_at:e.updatedAt,install_command:e.installCommand,readme:e.readme,versions:JSON.stringify(e.versions),dependencies:JSON.stringify(e.dependencies),issue_count:e.issueCount,config_subtype:e.configSubtype??null,files:JSON.stringify(e.files??[]),hub_score:t,hub_score_breakdown:JSON.stringify(a),upgrade_rate:0,compatibility:JSON.stringify(e.compatibility??{})}}(p)),e.authorId&&(u(e.authorId,"reputation",20,"publish_asset",r),u(e.authorId,"shrimp_coin",50,"publish_asset",r)),p}function m(e,t){let a=s();if(!a.prepare("SELECT * FROM assets WHERE id = ?").get(e))return null;let r=[],i={id:e};return void 0!==t.name&&(r.push("name = @name"),i.name=t.name),void 0!==t.displayName&&(r.push("display_name = @dn"),i.dn=t.displayName),void 0!==t.description&&(r.push("description = @desc"),i.desc=t.description),void 0!==t.longDescription&&(r.push("long_description = @ld"),i.ld=t.longDescription),void 0!==t.version&&(r.push("version = @ver"),i.ver=t.version),void 0!==t.tags&&(r.push("tags = @tags"),i.tags=JSON.stringify(t.tags)),void 0!==t.category&&(r.push("category = @cat"),i.cat=t.category),void 0!==t.readme&&(r.push("readme = @rm"),i.rm=t.readme),void 0!==t.authorId&&(r.push("author_id = @ai"),i.ai=t.authorId),void 0!==t.authorName&&(r.push("author_name = @an"),i.an=t.authorName),void 0!==t.authorAvatar&&(r.push("author_avatar = @aa"),i.aa=t.authorAvatar),void 0!==t.files&&(r.push("files = @files"),i.files=JSON.stringify(t.files)),r.push("updated_at = @ua"),i.ua=new Date().toISOString().split("T")[0],a.prepare(`UPDATE assets SET ${r.join(", ")} WHERE id = @id`).run(i),p(a.prepare("SELECT * FROM assets WHERE id = ?").get(e))}function N(e){return s().prepare("DELETE FROM assets WHERE id = ?").run(e).changes>0}function g(e,t){return s().prepare("SELECT * FROM users WHERE provider = ? AND provider_id = ?").get(e,t)??null}function O(e){return s().prepare("SELECT * FROM users WHERE id = ?").get(e)??null}function R(e){let t=new Date().toISOString();return s().prepare("INSERT INTO users (id,email,name,avatar,provider,provider_id,bio,invite_code,created_at,updated_at,reputation,shrimp_coins,onboarding_completed,provider_name,provider_avatar) VALUES (?,?,?,?,?,?,'',NULL,?,?,0,?,0,?,?)").run(e.id,e.email,e.name,e.avatar,e.provider,e.providerId,t,t,100,e.name,e.avatar),u(e.id,"shrimp_coin",0,"register_bonus"),O(e.id)}function S(e){let t=new Date().toISOString();return s().prepare("UPDATE users SET deleted_at = ?, updated_at = ? WHERE id = ? AND deleted_at IS NULL").run(t,t,e).changes>0}function A(e,t){let a=new Date().toISOString();return s().prepare("UPDATE users SET name = ?, avatar = ?, custom_name = ?, custom_avatar = ?, onboarding_completed = 1, updated_at = ? WHERE id = ?").run(t.name,t.avatar,t.name,t.avatar,a,e).changes>0}function h(e,t,a){s().prepare("UPDATE users SET provider_name = ?, provider_avatar = ?, updated_at = ? WHERE id = ?").run(t,a,new Date().toISOString(),e)}function y(e){return s().prepare("SELECT * FROM users WHERE email = ?").get(e)??null}function f(e){return s().prepare("INSERT OR REPLACE INTO verification_tokens (identifier, token, expires) VALUES (?, ?, ?)").run(e.identifier,e.token,e.expires.toISOString()),e}function v(e){let t=s(),a=t.prepare("SELECT * FROM verification_tokens WHERE identifier = ? AND token = ?").get(e.identifier,e.token);return a?(t.prepare("DELETE FROM verification_tokens WHERE identifier = ? AND token = ?").run(e.identifier,e.token),{identifier:a.identifier,token:a.token,expires:new Date(a.expires)}):null}function U(e,t){let a=s(),r=O(e);if(!r)return{success:!1,error:"ç”¨æˆ·ä¸å­˜åœ¨"};if(r.invite_code)return{success:!1,error:"å·²æ¿€æ´»é‚€è¯·ç "};let i=a.prepare("SELECT * FROM invite_codes WHERE code = ?").get(t);if(!i)return{success:!1,error:"é‚€è¯·ç ä¸å­˜åœ¨"};if(i.use_count>=i.max_uses)return{success:!1,error:"é‚€è¯·ç å·²ç”¨å®Œ"};if(i.expires_at&&new Date(i.expires_at)<new Date)return{success:!1,error:"é‚€è¯·ç å·²è¿‡æœŸ"};let n=new Date().toISOString();a.transaction(()=>{a.prepare("UPDATE users SET invite_code = ?, updated_at = ? WHERE id = ?").run(t,n,e),a.prepare("UPDATE invite_codes SET use_count = use_count + 1, used_at = ? WHERE code = ?").run(n,t),function(e){let t=s(),a=new Date().toISOString(),r=[],i=t.prepare("INSERT OR IGNORE INTO invite_codes (code, created_by, max_uses, use_count, type, created_at) VALUES (?, ?, 1, 0, 'normal', ?)"),n=0;for(;r.length<6&&n<30;){let t=function(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZ",t="";for(let a=0;a<7;a++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}();i.run(t,e,a).changes>0&&r.push(t),n++}}(e)})();let o=a.prepare("SELECT created_by FROM invite_codes WHERE code = ?").get(t);return o?.created_by&&"system"!==o.created_by&&(u(o.created_by,"reputation",10,"invite_user",e),u(o.created_by,"shrimp_coin",30,"invite_user",e)),{success:!0}}function I(e){let t=s().prepare("SELECT * FROM invite_codes WHERE code = ?").get(e);return t?t.use_count>=t.max_uses?{valid:!1,error:"é‚€è¯·ç å·²ç”¨å®Œ"}:t.expires_at&&new Date(t.expires_at)<new Date?{valid:!1,error:"é‚€è¯·ç å·²è¿‡æœŸ"}:{valid:!0}:{valid:!1,error:"é‚€è¯·ç ä¸å­˜åœ¨"}}function D(e){return{code:e.code,createdBy:e.created_by,usedBy:e.used_by,usedAt:e.used_at,maxUses:e.max_uses,useCount:e.use_count,expiresAt:e.expires_at,type:e.type,createdAt:e.created_at}}function C(e){return s().prepare("SELECT * FROM invite_codes WHERE created_by = ? ORDER BY created_at DESC").all(e).map(D)}function F(e,t,a){let r=s(),i=new Date().toISOString();try{return r.prepare("INSERT INTO invite_codes (code, created_by, max_uses, use_count, type, created_at) VALUES (?, ?, ?, 0, 'super', ?)").run(e,a,t,i),!0}catch{return!1}}function X(e){let t=s().prepare("SELECT * FROM invite_codes WHERE code = ?").get(e);return t?D(t):null}function b(e){let t=s(),a=[],r={};e?.type&&(a.push("type = @type"),r.type=e.type);let i=a.length>0?"WHERE "+a.join(" AND "):"",n=t.prepare(`SELECT COUNT(*) as cnt FROM invite_codes ${i}`).get(r).cnt,o=Math.max(1,e?.page??1),d=Math.min(100,Math.max(1,e?.pageSize??20));return{codes:t.prepare(`SELECT * FROM invite_codes ${i} ORDER BY created_at DESC LIMIT @limit OFFSET @offset`).all({...r,limit:d,offset:(o-1)*d}).map(D),total:n}}function M(e){return s().prepare("DELETE FROM invite_codes WHERE code = ?").run(e).changes>0}function w(e){let t=O(e);return!!t?.invite_code}function H(e,t,a=""){let r=new Date().toISOString();return s().prepare("INSERT OR REPLACE INTO authorized_devices (device_id, user_id, name, authorized_at) VALUES (?, ?, ?, ?)").run(t,e,a,r),!0}function B(e){let t=s().prepare("SELECT user_id, name FROM authorized_devices WHERE device_id = ?").get(e);return t?(s().prepare("UPDATE authorized_devices SET last_publish_at = ? WHERE device_id = ?").run(new Date().toISOString(),e),{userId:t.user_id,name:t.name}):null}function W(e){return s().prepare("SELECT device_id, name, authorized_at, last_publish_at FROM authorized_devices WHERE user_id = ?").all(e).map(e=>({deviceId:e.device_id.slice(0,12)+"...",name:e.name,authorizedAt:e.authorized_at,lastPublishAt:e.last_publish_at}))}function Y(e,t){return s().prepare("DELETE FROM authorized_devices WHERE device_id = ? AND user_id = ?").run(e,t).changes>0}function k(e){let t=!!e.is_agent;return{id:e.id,name:e.name,avatar:e.avatar,bio:e.bio,joinedAt:e.joined_at,publishedAssets:JSON.parse(e.published_assets),favoriteAssets:JSON.parse(e.favorite_assets),followers:e.followers,following:e.following,isAgent:t,agentConfig:t?{model:e.agent_model||"",uptime:e.agent_uptime||"",tasksCompleted:e.agent_tasks_completed,specialization:e.agent_specialization?JSON.parse(e.agent_specialization):[]}:void 0,contributionPoints:e.contribution_points,contributorLevel:e.contributor_level,instanceId:e.instance_id??void 0}}function x(e){let t=s().prepare("SELECT * FROM user_profiles WHERE id = ?").get(e);return t?k(t):null}function P(){return s().prepare("SELECT * FROM user_profiles ORDER BY followers DESC").all().map(k)}function G(e){return s().prepare("SELECT * FROM user_profiles WHERE name LIKE ? OR bio LIKE ? ORDER BY followers DESC").all(`%${e}%`,`%${e}%`).map(k)}function K(e){return{id:e.id,assetId:e.asset_id,userId:e.user_id,userName:e.user_name,userAvatar:e.user_avatar,content:e.content,rating:e.rating,createdAt:e.created_at,commenterType:e.commenter_type}}function J(e){return s().prepare("SELECT * FROM comments WHERE asset_id = ? ORDER BY created_at DESC").all(e).map(K)}function $(e){let t=s(),a="cm-"+Math.random().toString(36).substring(2,8),r=new Date().toISOString().split("T")[0];t.prepare("INSERT INTO comments (id,asset_id,user_id,user_name,user_avatar,content,rating,created_at,commenter_type) VALUES (?,?,?,?,?,?,?,?,?)").run(a,e.assetId,e.userId,e.userName,e.userAvatar,e.content,e.rating,r,e.commenterType??"user"),u(e.userId,"reputation",2,"write_comment",e.assetId),u(e.userId,"shrimp_coin",3,"write_comment",e.assetId);let i=t.prepare("SELECT author_id FROM assets WHERE id = ?").get(e.assetId);return i?.author_id&&i.author_id!==e.userId&&(e.rating>=4&&u(i.author_id,"reputation",5,"asset_rated_good",e.assetId),5===e.rating&&u(i.author_id,"shrimp_coin",15,"asset_rated_5star",e.assetId)),d(e.assetId),{id:a,...e,createdAt:r}}function z(e){return{id:e.id,assetId:e.asset_id,authorId:e.author_id,authorName:e.author_name,authorAvatar:e.author_avatar,authorType:e.author_type,title:e.title,body:e.body,status:e.status,labels:JSON.parse(e.labels),createdAt:e.created_at,commentCount:e.comment_count}}function j(e){return s().prepare("SELECT * FROM issues WHERE asset_id = ? ORDER BY created_at DESC").all(e).map(z)}function q(e){let t=s(),a="is-"+Math.random().toString(36).substring(2,8),r=new Date().toISOString().split("T")[0];return t.prepare("INSERT INTO issues (id,asset_id,author_id,author_name,author_avatar,author_type,title,body,status,labels,created_at,comment_count) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)").run(a,e.assetId,e.authorId,e.authorName,e.authorAvatar,e.authorType??"user",e.title,e.body,"open",JSON.stringify(e.labels??[]),r,0),u(e.authorId,"reputation",2,"submit_issue",e.assetId),u(e.authorId,"shrimp_coin",5,"submit_issue",e.assetId),{id:a,...e,status:"open",createdAt:r,commentCount:0}}function V(e){return s().prepare("SELECT * FROM issues WHERE title LIKE ? OR body LIKE ? ORDER BY created_at DESC").all(`%${e}%`,`%${e}%`).map(z)}function Q(e){return{id:e.id,title:e.title,description:e.description,curatorId:e.curator_id,curatorName:e.curator_name,curatorAvatar:e.curator_avatar,assetIds:JSON.parse(e.asset_ids),coverEmoji:e.cover_emoji,followers:e.followers,createdAt:e.created_at}}function Z(e){return s().prepare("SELECT * FROM collections WHERE title LIKE ? OR description LIKE ? ORDER BY followers DESC").all(`%${e}%`,`%${e}%`).map(Q)}function ee(e){return{id:e.id,type:e.type,title:e.title,message:e.message,icon:e.icon,linkTo:e.link_to??void 0,read:!!e.is_read,createdAt:e.created_at}}function et(e="self"){return s().prepare("SELECT * FROM notifications WHERE user_id = ? ORDER BY created_at DESC").all(e).map(ee)}function ea(e){s().prepare("UPDATE notifications SET is_read = 1 WHERE id = ?").run(e)}function er(e="self"){s().prepare("UPDATE notifications SET is_read = 1 WHERE user_id = ?").run(e)}function ei(e){return s().prepare("SELECT * FROM evolution_events WHERE user_id = ? ORDER BY date ASC").all(e).map(e=>({id:e.id,userId:e.user_id,icon:e.icon,title:e.title,description:e.description,date:e.date,type:e.type}))}function en(e){return s().prepare("SELECT * FROM activity_events WHERE user_id = ? ORDER BY date DESC").all(e).map(e=>({id:e.id,userId:e.user_id,icon:e.icon,text:e.text,date:e.date,type:e.type,linkTo:e.link_to??void 0,actorType:e.actor_type}))}function es(){return s().prepare("SELECT * FROM daily_stats ORDER BY day ASC").all().map(e=>({day:e.day,downloads:e.downloads,newAssets:e.new_assets,newUsers:e.new_users}))}function eo(){let e=s(),t=e.prepare("SELECT COUNT(*) as cnt FROM assets").get().cnt,a=e.prepare("SELECT COUNT(DISTINCT author_id) as cnt FROM assets WHERE author_id != ''").get().cnt,r=e.prepare("SELECT COALESCE(SUM(downloads), 0) as total FROM assets").get().total,i=new Date(Date.now()-6048e5).toISOString().split("T")[0],n=e.prepare("SELECT COUNT(*) as cnt FROM assets WHERE created_at >= ?").get(i).cnt;return{totalAssets:t,totalDevelopers:a,totalDownloads:r,weeklyNew:n,topDevelopers:e.prepare("SELECT author_id as id, author_name as name, author_avatar as avatar, COUNT(*) as assetCount, COALESCE(SUM(downloads),0) as totalDownloads FROM assets WHERE author_id != '' GROUP BY author_id ORDER BY totalDownloads DESC LIMIT 10").all(),recentActivity:e.prepare("SELECT name, display_name, author_name, author_avatar, version, created_at, updated_at FROM assets ORDER BY updated_at DESC LIMIT 20").all().map(e=>({type:e.created_at===e.updated_at?"publish":"update",authorName:e.author_name,authorAvatar:e.author_avatar,assetName:e.name,assetDisplayName:e.display_name,version:e.version,timestamp:e.updated_at}))}}function ed(){let e=s().prepare("SELECT type, COUNT(*) as cnt FROM assets GROUP BY type").all(),t={};for(let a of e)t[a.type]=a.cnt;return t}function eE(){return s().prepare("SELECT COUNT(*) as cnt FROM comments").get().cnt}function eu(){return s().prepare("SELECT COUNT(*) as cnt FROM issues").get().cnt}function eT(e){let t,a=s(),r=[],i={};e.type&&["skill","config","plugin","trigger","channel","template"].includes(e.type)&&(r.push("type = @type"),i.type=e.type),e.category&&(r.push("category = @category"),i.category=e.category),e.tag&&(r.push("tags LIKE @tag"),i.tag=`%"${e.tag}"%`),e.q&&(r.push("(name LIKE @q OR display_name LIKE @q OR description LIKE @q OR tags LIKE @q)"),i.q=`%${e.q}%`);let n=r.length>0?"WHERE "+r.join(" AND "):"",o=a.prepare(`SELECT COUNT(*) as cnt FROM assets ${n}`).get(i).cnt;switch(e.sort){case"installs":case"downloads":t="downloads DESC";break;case"rating":t="rating DESC";break;case"newest":case"updated_at":t="updated_at DESC";break;case"created_at":t="created_at DESC";break;default:t="downloads DESC, updated_at DESC"}let d=Math.max(1,e.page??1),E=Math.min(100,Math.max(1,e.pageSize??20));return{assets:a.prepare(`SELECT id, name, display_name, type, description, tags, downloads, rating, author_name, author_id, version, install_command, updated_at, category FROM assets ${n} ORDER BY ${t} LIMIT @limit OFFSET @offset`).all({...i,limit:E,offset:(d-1)*E}).map(e=>({id:e.id,name:e.name,displayName:e.display_name,type:e.type,description:e.description,tags:JSON.parse(e.tags),installs:e.downloads,rating:e.rating,author:e.author_name,authorId:e.author_id,version:e.version,installCommand:e.install_command,updatedAt:e.updated_at,category:e.category})),total:o,page:d,pageSize:E}}function ec(){let e=s().prepare("SELECT tags FROM assets").all(),t=new Map;for(let a of e)for(let e of JSON.parse(a.tags))t.set(e,(t.get(e)??0)+1);return[...t.entries()].map(([e,t])=>({name:e,count:t})).sort((e,t)=>t.count-e.count)}function ep(){return s().prepare("SELECT category, COUNT(*) as cnt FROM assets WHERE category != '' GROUP BY category ORDER BY cnt DESC").all().map(e=>({name:e.category,count:e.cnt}))}function el(e){let t=s().prepare("SELECT id, manifest FROM assets WHERE id = ?").get(e);return t?{id:t.id,manifest:JSON.parse(t.manifest||"{}")}:null}function e_(e,t){return s().prepare("UPDATE assets SET manifest = ? WHERE id = ?").run(JSON.stringify(t),e).changes>0}function eL(e){let t=s().prepare("SELECT name, display_name, readme, version FROM assets WHERE id = ?").get(e);return t?{name:t.name,displayName:t.display_name,readme:t.readme,version:t.version}:null}function em(e){if(0===e.length)return[];let t=s(),a=e.map(()=>"?").join(",");return t.prepare(`SELECT id, name, display_name, type, description, tags, downloads, rating, author_name, author_id, version, install_command, updated_at, category FROM assets WHERE id IN (${a})`).all(...e).map(e=>({id:e.id,name:e.name,displayName:e.display_name,type:e.type,description:e.description,tags:JSON.parse(e.tags),installs:e.downloads,rating:e.rating,author:e.author_name,authorId:e.author_id,version:e.version,installCommand:e.install_command,updatedAt:e.updated_at,category:e.category}))}function eN(e,t=10){return s().prepare("SELECT id, name, display_name, type, description, tags, downloads, rating, author_name, author_id, version, install_command, updated_at, category FROM assets ORDER BY downloads DESC, updated_at DESC LIMIT ?").all(Math.min(t,50)).map(e=>({id:e.id,name:e.name,displayName:e.display_name,type:e.type,description:e.description,tags:JSON.parse(e.tags),installs:e.downloads,rating:e.rating,author:e.author_name,authorId:e.author_id,version:e.version,installCommand:e.install_command,updatedAt:e.updated_at,category:e.category}))}e.s(["activateInviteCode",()=>U,"authorizeDevice",()=>H,"completeOnboarding",()=>A,"createAsset",()=>L,"createComment",()=>$,"createIssue",()=>q,"createSuperInviteCode",()=>F,"createUser",()=>R,"createVerificationToken",()=>f,"deleteAsset",()=>N,"deleteInviteCode",()=>M,"findUserByEmail",()=>y,"findUserById",()=>O,"findUserByProvider",()=>g,"getActivityEventsByUserId",()=>en,"getAllCategories",()=>ep,"getAllTags",()=>ec,"getAssetById",()=>_,"getAssetCountByType",()=>ed,"getAssetManifest",()=>el,"getAssetReadme",()=>eL,"getAssetsByIds",()=>em,"getCoinHistory",()=>c,"getCommentsByAssetId",()=>J,"getEvolutionEventsByUserId",()=>ei,"getGrowthData",()=>es,"getInviteCodeDetail",()=>X,"getIssuesByAssetId",()=>j,"getNotifications",()=>et,"getStats",()=>eo,"getTotalCommentCount",()=>eE,"getTotalIssueCount",()=>eu,"getTrendingAssets",()=>eN,"getUserCoins",()=>T,"getUserInviteCodes",()=>C,"getUserProfile",()=>x,"incrementDownload",()=>E,"listAllInviteCodes",()=>b,"listAssets",()=>l,"listAssetsCompact",()=>eT,"listAuthorizedDevices",()=>W,"listUserProfiles",()=>P,"markAllRead",()=>er,"markNotificationRead",()=>ea,"revokeDevice",()=>Y,"searchCollections",()=>Z,"searchIssues",()=>V,"searchUserProfiles",()=>G,"softDeleteUser",()=>S,"updateAsset",()=>m,"updateAssetManifest",()=>e_,"updateProviderInfo",()=>h,"useVerificationToken",()=>v,"userHasInviteAccess",()=>w,"validateDevice",()=>B,"validateInviteCode",()=>I],43793)}];

//# sourceMappingURL=src_lib_db_ts_86d9618b._.js.map