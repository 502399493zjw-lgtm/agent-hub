module.exports=[43793,e=>{"use strict";var t=e.i(85148),a=e.i(14747);let r=[{code:"SEAFOOD",maxUses:100,type:"super"},{code:"OPENCLAW",maxUses:100,type:"super"},{code:"AGENTHUB",maxUses:50,type:"super"}],s=a.default.join(process.cwd(),"data","hub.db"),n=null;function i(){return n||((n=new t.default(s)).pragma("journal_mode = WAL"),function(e){e.exec(`
    CREATE TABLE IF NOT EXISTS assets (
      id TEXT PRIMARY KEY, name TEXT NOT NULL, display_name TEXT NOT NULL,
      type TEXT NOT NULL CHECK(type IN ('skill','channel','plugin','trigger','config','template')),
      author_id TEXT NOT NULL DEFAULT '', author_name TEXT NOT NULL DEFAULT '', author_avatar TEXT NOT NULL DEFAULT '',
      description TEXT NOT NULL DEFAULT '', long_description TEXT NOT NULL DEFAULT '',
      version TEXT NOT NULL DEFAULT '1.0.0', downloads INTEGER NOT NULL DEFAULT 0,
      rating REAL NOT NULL DEFAULT 0, rating_count INTEGER NOT NULL DEFAULT 0,
      tags TEXT NOT NULL DEFAULT '[]', category TEXT NOT NULL DEFAULT '',
      created_at TEXT NOT NULL DEFAULT '', updated_at TEXT NOT NULL DEFAULT '',
      install_command TEXT NOT NULL DEFAULT '', readme TEXT NOT NULL DEFAULT '',
      versions TEXT NOT NULL DEFAULT '[]', dependencies TEXT NOT NULL DEFAULT '[]',
      issue_count INTEGER NOT NULL DEFAULT 0, config_subtype TEXT,
      hub_score INTEGER NOT NULL DEFAULT 70, hub_score_breakdown TEXT NOT NULL DEFAULT '{}',
      upgrade_rate REAL NOT NULL DEFAULT 50, compatibility TEXT NOT NULL DEFAULT '{}',
      files TEXT NOT NULL DEFAULT '[]'
    );
    CREATE TABLE IF NOT EXISTS users (
      id TEXT PRIMARY KEY, email TEXT UNIQUE, name TEXT NOT NULL, avatar TEXT DEFAULT '',
      provider TEXT NOT NULL, provider_id TEXT NOT NULL, bio TEXT DEFAULT '',
      invite_code TEXT, created_at TEXT NOT NULL, updated_at TEXT NOT NULL, deleted_at TEXT,
      UNIQUE(provider, provider_id)
    );
    CREATE TABLE IF NOT EXISTS invite_codes (
      code TEXT PRIMARY KEY, created_by TEXT DEFAULT 'system', used_by TEXT, used_at TEXT,
      max_uses INTEGER DEFAULT 1, use_count INTEGER DEFAULT 0, expires_at TEXT, created_at TEXT NOT NULL,
      type TEXT NOT NULL DEFAULT 'normal'
    );
    CREATE TABLE IF NOT EXISTS user_profiles (
      id TEXT PRIMARY KEY, name TEXT NOT NULL, avatar TEXT NOT NULL DEFAULT '', bio TEXT NOT NULL DEFAULT '',
      joined_at TEXT NOT NULL DEFAULT '', published_assets TEXT NOT NULL DEFAULT '[]',
      favorite_assets TEXT NOT NULL DEFAULT '[]', followers INTEGER NOT NULL DEFAULT 0,
      following INTEGER NOT NULL DEFAULT 0, is_agent BOOLEAN NOT NULL DEFAULT 0,
      agent_model TEXT, agent_uptime TEXT, agent_tasks_completed INTEGER NOT NULL DEFAULT 0,
      agent_specialization TEXT, contribution_points INTEGER NOT NULL DEFAULT 0,
      contributor_level TEXT NOT NULL DEFAULT 'newcomer', instance_id TEXT
    );
    CREATE TABLE IF NOT EXISTS comments (
      id TEXT PRIMARY KEY, asset_id TEXT NOT NULL, user_id TEXT NOT NULL,
      user_name TEXT, user_avatar TEXT, content TEXT, rating INTEGER,
      created_at TEXT, commenter_type TEXT NOT NULL DEFAULT 'user'
    );
    CREATE TABLE IF NOT EXISTS issues (
      id TEXT PRIMARY KEY, asset_id TEXT NOT NULL, author_id TEXT,
      author_name TEXT, author_avatar TEXT, author_type TEXT NOT NULL DEFAULT 'user',
      title TEXT, body TEXT, status TEXT NOT NULL DEFAULT 'open',
      labels TEXT NOT NULL DEFAULT '[]', created_at TEXT, comment_count INTEGER NOT NULL DEFAULT 0
    );
    CREATE TABLE IF NOT EXISTS collections (
      id TEXT PRIMARY KEY, title TEXT, description TEXT,
      curator_id TEXT, curator_name TEXT, curator_avatar TEXT,
      asset_ids TEXT NOT NULL DEFAULT '[]', cover_emoji TEXT,
      followers INTEGER NOT NULL DEFAULT 0, created_at TEXT
    );
    CREATE TABLE IF NOT EXISTS notifications (
      id TEXT PRIMARY KEY, user_id TEXT NOT NULL DEFAULT 'self', type TEXT,
      title TEXT, message TEXT, icon TEXT, link_to TEXT,
      is_read BOOLEAN NOT NULL DEFAULT 0, created_at TEXT
    );
    CREATE TABLE IF NOT EXISTS evolution_events (
      id TEXT PRIMARY KEY, user_id TEXT NOT NULL, icon TEXT,
      title TEXT, description TEXT, date TEXT, type TEXT
    );
    CREATE TABLE IF NOT EXISTS activity_events (
      id TEXT PRIMARY KEY, user_id TEXT NOT NULL, icon TEXT,
      text TEXT, date TEXT, type TEXT, link_to TEXT,
      actor_type TEXT NOT NULL DEFAULT 'user'
    );
    CREATE TABLE IF NOT EXISTS authorized_devices (
      device_id TEXT PRIMARY KEY,
      user_id TEXT NOT NULL,
      name TEXT NOT NULL DEFAULT '',
      authorized_at TEXT NOT NULL,
      last_publish_at TEXT,
      FOREIGN KEY (user_id) REFERENCES users(id)
    );
    CREATE TABLE IF NOT EXISTS daily_stats (
      day INTEGER PRIMARY KEY, downloads INTEGER NOT NULL DEFAULT 0,
      new_assets INTEGER NOT NULL DEFAULT 0, new_users INTEGER NOT NULL DEFAULT 0
    );
    CREATE TABLE IF NOT EXISTS coin_events (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      user_id TEXT NOT NULL,
      coin_type TEXT NOT NULL CHECK(coin_type IN ('reputation', 'shrimp_coin')),
      amount INTEGER NOT NULL,
      event TEXT NOT NULL,
      ref_id TEXT,
      balance_after INTEGER NOT NULL DEFAULT 0,
      created_at TEXT NOT NULL
    );
    CREATE INDEX IF NOT EXISTS idx_coin_events_user ON coin_events(user_id, coin_type);
    CREATE INDEX IF NOT EXISTS idx_coin_events_ref ON coin_events(ref_id);
  `);try{e.exec("ALTER TABLE users ADD COLUMN reputation INTEGER NOT NULL DEFAULT 0")}catch{}try{e.exec("ALTER TABLE users ADD COLUMN shrimp_coins INTEGER NOT NULL DEFAULT 100")}catch{}try{e.exec("ALTER TABLE users ADD COLUMN onboarding_completed INTEGER NOT NULL DEFAULT 0")}catch{}try{e.exec("ALTER TABLE users ADD COLUMN custom_name TEXT")}catch{}try{e.exec("ALTER TABLE users ADD COLUMN custom_avatar TEXT")}catch{}try{e.exec("ALTER TABLE users ADD COLUMN provider_name TEXT")}catch{}try{e.exec("ALTER TABLE users ADD COLUMN provider_avatar TEXT")}catch{}try{e.exec("ALTER TABLE assets ADD COLUMN manifest TEXT NOT NULL DEFAULT '{}'")}catch{}if(0===e.prepare("SELECT COUNT(*) as cnt FROM invite_codes").get().cnt){let t=new Date().toISOString(),a=e.prepare("INSERT OR IGNORE INTO invite_codes (code, created_by, max_uses, use_count, type, created_at) VALUES (?, 'system', ?, 0, ?, ?)");for(let e of r)a.run(e.code,e.maxUses,e.type??"system",t)}}(n)),n}function o(e,t,a){return{hubScore:0,hubScoreBreakdown:{downloadScore:0,maintenanceScore:0,reputationScore:0}}}function d(e){let t=i(),a=t.prepare("SELECT downloads, rating, rating_count FROM assets WHERE id = ?").get(e);if(!a)return;let{hubScore:r,hubScoreBreakdown:s}=o(a.downloads,a.rating,a.rating_count);t.prepare("UPDATE assets SET hub_score = ?, hub_score_breakdown = ? WHERE id = ?").run(r,JSON.stringify(s),e)}function E(e){let t=i();if(0===t.prepare("UPDATE assets SET downloads = downloads + 1 WHERE id = ?").run(e).changes)return null;d(e);let a=t.prepare("SELECT author_id, downloads FROM assets WHERE id = ?").get(e);return a?.author_id&&(u(a.author_id,"reputation",3,"asset_installed",e),u(a.author_id,"shrimp_coin",10,"asset_installed",e)),a?.downloads??null}function u(e,t,a,r,s){let n=i(),o="reputation"===t?"reputation":"shrimp_coins",d=n.prepare(`SELECT ${o} FROM users WHERE id = ?`).get(e);if(!d)return;let E=Math.max(0,(d[o]??0)+a);n.prepare(`UPDATE users SET ${o} = ? WHERE id = ?`).run(E,e),n.prepare("INSERT INTO coin_events (user_id, coin_type, amount, event, ref_id, balance_after, created_at) VALUES (?, ?, ?, ?, ?, ?, ?)").run(e,t,a,r,s??null,E,new Date().toISOString())}function T(e){let t=i().prepare("SELECT reputation, shrimp_coins FROM users WHERE id = ?").get(e);return{reputation:t?.reputation??0,shrimpCoins:t?.shrimp_coins??100}}function c(e,t,a=50){let r=i(),s="SELECT * FROM coin_events WHERE user_id = ?",n=[e];return t&&(s+=" AND coin_type = ?",n.push(t)),s+=" ORDER BY id DESC LIMIT ?",n.push(a),r.prepare(s).all(...n).map(e=>({id:e.id,coinType:e.coin_type,amount:e.amount,event:e.event,refId:e.ref_id,balanceAfter:e.balance_after,createdAt:e.created_at}))}function p(e){return{id:e.id,name:e.name,displayName:e.display_name,type:e.type,author:{id:e.author_id||"u-"+e.author_name.toLowerCase().replace(/\s+/g,"-"),name:e.author_name,avatar:e.author_avatar},description:e.description,longDescription:e.long_description,version:e.version,downloads:e.downloads,rating:e.rating,ratingCount:e.rating_count,tags:JSON.parse(e.tags),category:e.category,createdAt:e.created_at,updatedAt:e.updated_at,installCommand:e.install_command,readme:e.readme,versions:JSON.parse(e.versions),dependencies:JSON.parse(e.dependencies),compatibility:JSON.parse(e.compatibility),issueCount:e.issue_count,files:JSON.parse(e.files||"[]"),configSubtype:e.config_subtype??void 0}}function l(e){let t,a=i(),r=[],s={};e.type&&["skill","config","plugin","trigger","channel","template"].includes(e.type)&&(r.push("type = @type"),s.type=e.type),e.category&&(r.push("category = @category"),s.category=e.category),e.q&&(r.push("(name LIKE @q OR display_name LIKE @q OR description LIKE @q OR tags LIKE @q)"),s.q=`%${e.q}%`);let n=r.length>0?"WHERE "+r.join(" AND "):"",o=a.prepare(`SELECT COUNT(*) as cnt FROM assets ${n}`).get(s).cnt;switch(e.sort){case"downloads":t="downloads DESC";break;case"rating":t="rating DESC";break;case"updated_at":case"newest":t="updated_at DESC";break;case"created_at":t="created_at DESC";break;case"trending":t="downloads DESC, updated_at DESC";break;default:t="(downloads * rating) DESC"}let d=Math.max(1,e.page??1),E=Math.min(100,Math.max(1,e.pageSize??20));return{assets:a.prepare(`SELECT * FROM assets ${n} ORDER BY ${t} LIMIT @limit OFFSET @offset`).all({...s,limit:E,offset:(d-1)*E}).map(p),total:o,page:d,pageSize:E}}function _(e){let t=i().prepare("SELECT * FROM assets WHERE id = ?").get(e);return t?p(t):null}function m(e){let t=i(),a={skill:"s",config:"c",plugin:"p",trigger:"tr",channel:"ch",template:"t"}[e.type]||"x",r=`${a}-${Math.random().toString(36).substring(2,8)}`,s=new Date().toISOString().split("T")[0],n=e.authorName||"CyberNova",d=e.authorAvatar||"ğŸ¤–",E=e.authorId||"u-"+n.toLowerCase().replace(/\s+/g,"-"),{hubScore:T,hubScoreBreakdown:c}=o(0,0,0),p={id:r,name:e.name,displayName:e.displayName,type:e.type,author:{id:E,name:n,avatar:d},description:e.description,longDescription:e.longDescription||"",version:e.version,downloads:0,rating:0,ratingCount:0,tags:e.tags||[],category:e.category||"",createdAt:s,updatedAt:s,installCommand:`seafood-market install ${e.type}/@${E}/${e.name}`,readme:e.readme||"",versions:[{version:e.version,changelog:"é¦–æ¬¡å‘å¸ƒ",date:s}],dependencies:[],compatibility:{models:["GPT-4","Claude 3"],platforms:["OpenClaw"],frameworks:["Node.js"]},issueCount:0,configSubtype:e.configSubtype};return t.prepare("INSERT INTO assets (id,name,display_name,type,author_id,author_name,author_avatar,description,long_description,version,downloads,rating,rating_count,tags,category,created_at,updated_at,install_command,readme,versions,dependencies,issue_count,config_subtype,hub_score,hub_score_breakdown,upgrade_rate,compatibility,files) VALUES (@id,@name,@display_name,@type,@author_id,@author_name,@author_avatar,@description,@long_description,@version,@downloads,@rating,@rating_count,@tags,@category,@created_at,@updated_at,@install_command,@readme,@versions,@dependencies,@issue_count,@config_subtype,@hub_score,@hub_score_breakdown,@upgrade_rate,@compatibility,@files)").run(function(e){let{hubScore:t,hubScoreBreakdown:a}=o(e.downloads,e.rating,e.ratingCount);return{id:e.id,name:e.name,display_name:e.displayName,type:e.type,author_id:e.author.id,author_name:e.author.name,author_avatar:e.author.avatar,description:e.description,long_description:e.longDescription,version:e.version,downloads:e.downloads,rating:e.rating,rating_count:e.ratingCount,tags:JSON.stringify(e.tags),category:e.category,created_at:e.createdAt,updated_at:e.updatedAt,install_command:e.installCommand,readme:e.readme,versions:JSON.stringify(e.versions),dependencies:JSON.stringify(e.dependencies),issue_count:e.issueCount,config_subtype:e.configSubtype??null,files:JSON.stringify(e.files??[]),hub_score:t,hub_score_breakdown:JSON.stringify(a),upgrade_rate:0,compatibility:JSON.stringify(e.compatibility??{})}}(p)),e.authorId&&(u(e.authorId,"reputation",20,"publish_asset",r),u(e.authorId,"shrimp_coin",50,"publish_asset",r)),p}function L(e,t){let a=i();if(!a.prepare("SELECT * FROM assets WHERE id = ?").get(e))return null;let r=[],s={id:e};return void 0!==t.name&&(r.push("name = @name"),s.name=t.name),void 0!==t.displayName&&(r.push("display_name = @dn"),s.dn=t.displayName),void 0!==t.description&&(r.push("description = @desc"),s.desc=t.description),void 0!==t.longDescription&&(r.push("long_description = @ld"),s.ld=t.longDescription),void 0!==t.version&&(r.push("version = @ver"),s.ver=t.version),void 0!==t.tags&&(r.push("tags = @tags"),s.tags=JSON.stringify(t.tags)),void 0!==t.category&&(r.push("category = @cat"),s.cat=t.category),void 0!==t.readme&&(r.push("readme = @rm"),s.rm=t.readme),void 0!==t.authorId&&(r.push("author_id = @ai"),s.ai=t.authorId),void 0!==t.authorName&&(r.push("author_name = @an"),s.an=t.authorName),void 0!==t.authorAvatar&&(r.push("author_avatar = @aa"),s.aa=t.authorAvatar),void 0!==t.files&&(r.push("files = @files"),s.files=JSON.stringify(t.files)),r.push("updated_at = @ua"),s.ua=new Date().toISOString().split("T")[0],a.prepare(`UPDATE assets SET ${r.join(", ")} WHERE id = @id`).run(s),p(a.prepare("SELECT * FROM assets WHERE id = ?").get(e))}function N(e){return i().prepare("DELETE FROM assets WHERE id = ?").run(e).changes>0}function g(e,t){return i().prepare("SELECT * FROM users WHERE provider = ? AND provider_id = ?").get(e,t)??null}function O(e){return i().prepare("SELECT * FROM users WHERE id = ?").get(e)??null}function R(e){let t=new Date().toISOString();return i().prepare("INSERT INTO users (id,email,name,avatar,provider,provider_id,bio,invite_code,created_at,updated_at,reputation,shrimp_coins,onboarding_completed,provider_name,provider_avatar) VALUES (?,?,?,?,?,?,'',NULL,?,?,0,?,0,?,?)").run(e.id,e.email,e.name,e.avatar,e.provider,e.providerId,t,t,100,e.name,e.avatar),u(e.id,"shrimp_coin",0,"register_bonus"),O(e.id)}function S(e){let t=new Date().toISOString();return i().prepare("UPDATE users SET deleted_at = ?, updated_at = ? WHERE id = ? AND deleted_at IS NULL").run(t,t,e).changes>0}function y(e,t){let a=new Date().toISOString();return i().prepare("UPDATE users SET name = ?, avatar = ?, custom_name = ?, custom_avatar = ?, onboarding_completed = 1, updated_at = ? WHERE id = ?").run(t.name,t.avatar,t.name,t.avatar,a,e).changes>0}function A(e,t,a){i().prepare("UPDATE users SET provider_name = ?, provider_avatar = ?, updated_at = ? WHERE id = ?").run(t,a,new Date().toISOString(),e)}function h(e,t){let a=i(),r=O(e);if(!r)return{success:!1,error:"ç”¨æˆ·ä¸å­˜åœ¨"};if(r.invite_code)return{success:!1,error:"å·²æ¿€æ´»é‚€è¯·ç "};let s=a.prepare("SELECT * FROM invite_codes WHERE code = ?").get(t);if(!s)return{success:!1,error:"é‚€è¯·ç ä¸å­˜åœ¨"};if(s.use_count>=s.max_uses)return{success:!1,error:"é‚€è¯·ç å·²ç”¨å®Œ"};if(s.expires_at&&new Date(s.expires_at)<new Date)return{success:!1,error:"é‚€è¯·ç å·²è¿‡æœŸ"};let n=new Date().toISOString();a.transaction(()=>{a.prepare("UPDATE users SET invite_code = ?, updated_at = ? WHERE id = ?").run(t,n,e),a.prepare("UPDATE invite_codes SET use_count = use_count + 1, used_at = ? WHERE code = ?").run(n,t),function(e){let t=i(),a=new Date().toISOString(),r=[],s=t.prepare("INSERT OR IGNORE INTO invite_codes (code, created_by, max_uses, use_count, type, created_at) VALUES (?, ?, 1, 0, 'normal', ?)"),n=0;for(;r.length<6&&n<30;){let t=function(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZ",t="";for(let a=0;a<7;a++)t+=e.charAt(Math.floor(Math.random()*e.length));return t}();s.run(t,e,a).changes>0&&r.push(t),n++}}(e)})();let o=a.prepare("SELECT created_by FROM invite_codes WHERE code = ?").get(t);return o?.created_by&&"system"!==o.created_by&&(u(o.created_by,"reputation",10,"invite_user",e),u(o.created_by,"shrimp_coin",30,"invite_user",e)),{success:!0}}function v(e){let t=i().prepare("SELECT * FROM invite_codes WHERE code = ?").get(e);return t?t.use_count>=t.max_uses?{valid:!1,error:"é‚€è¯·ç å·²ç”¨å®Œ"}:t.expires_at&&new Date(t.expires_at)<new Date?{valid:!1,error:"é‚€è¯·ç å·²è¿‡æœŸ"}:{valid:!0}:{valid:!1,error:"é‚€è¯·ç ä¸å­˜åœ¨"}}function U(e){return{code:e.code,createdBy:e.created_by,usedBy:e.used_by,usedAt:e.used_at,maxUses:e.max_uses,useCount:e.use_count,expiresAt:e.expires_at,type:e.type,createdAt:e.created_at}}function I(e){return i().prepare("SELECT * FROM invite_codes WHERE created_by = ? ORDER BY created_at DESC").all(e).map(U)}function f(e,t,a){let r=i(),s=new Date().toISOString();try{return r.prepare("INSERT INTO invite_codes (code, created_by, max_uses, use_count, type, created_at) VALUES (?, ?, ?, 0, 'super', ?)").run(e,a,t,s),!0}catch{return!1}}function D(e){let t=i().prepare("SELECT * FROM invite_codes WHERE code = ?").get(e);return t?U(t):null}function C(e){let t=i(),a=[],r={};e?.type&&(a.push("type = @type"),r.type=e.type);let s=a.length>0?"WHERE "+a.join(" AND "):"",n=t.prepare(`SELECT COUNT(*) as cnt FROM invite_codes ${s}`).get(r).cnt,o=Math.max(1,e?.page??1),d=Math.min(100,Math.max(1,e?.pageSize??20));return{codes:t.prepare(`SELECT * FROM invite_codes ${s} ORDER BY created_at DESC LIMIT @limit OFFSET @offset`).all({...r,limit:d,offset:(o-1)*d}).map(U),total:n}}function F(e){return i().prepare("DELETE FROM invite_codes WHERE code = ?").run(e).changes>0}function X(e){let t=O(e);return!!t?.invite_code}function b(e,t,a=""){let r=new Date().toISOString();return i().prepare("INSERT OR REPLACE INTO authorized_devices (device_id, user_id, name, authorized_at) VALUES (?, ?, ?, ?)").run(t,e,a,r),!0}function M(e){let t=i().prepare("SELECT user_id, name FROM authorized_devices WHERE device_id = ?").get(e);return t?(i().prepare("UPDATE authorized_devices SET last_publish_at = ? WHERE device_id = ?").run(new Date().toISOString(),e),{userId:t.user_id,name:t.name}):null}function w(e){return i().prepare("SELECT device_id, name, authorized_at, last_publish_at FROM authorized_devices WHERE user_id = ?").all(e).map(e=>({deviceId:e.device_id.slice(0,12)+"...",name:e.name,authorizedAt:e.authorized_at,lastPublishAt:e.last_publish_at}))}function B(e,t){return i().prepare("DELETE FROM authorized_devices WHERE device_id = ? AND user_id = ?").run(e,t).changes>0}function H(e){let t=!!e.is_agent;return{id:e.id,name:e.name,avatar:e.avatar,bio:e.bio,joinedAt:e.joined_at,publishedAssets:JSON.parse(e.published_assets),favoriteAssets:JSON.parse(e.favorite_assets),followers:e.followers,following:e.following,isAgent:t,agentConfig:t?{model:e.agent_model||"",uptime:e.agent_uptime||"",tasksCompleted:e.agent_tasks_completed,specialization:e.agent_specialization?JSON.parse(e.agent_specialization):[]}:void 0,contributionPoints:e.contribution_points,contributorLevel:e.contributor_level,instanceId:e.instance_id??void 0}}function W(e){let t=i().prepare("SELECT * FROM user_profiles WHERE id = ?").get(e);return t?H(t):null}function Y(){return i().prepare("SELECT * FROM user_profiles ORDER BY followers DESC").all().map(H)}function x(e){return i().prepare("SELECT * FROM user_profiles WHERE name LIKE ? OR bio LIKE ? ORDER BY followers DESC").all(`%${e}%`,`%${e}%`).map(H)}function P(e){return{id:e.id,assetId:e.asset_id,userId:e.user_id,userName:e.user_name,userAvatar:e.user_avatar,content:e.content,rating:e.rating,createdAt:e.created_at,commenterType:e.commenter_type}}function k(e){return i().prepare("SELECT * FROM comments WHERE asset_id = ? ORDER BY created_at DESC").all(e).map(P)}function G(e){let t=i(),a="cm-"+Math.random().toString(36).substring(2,8),r=new Date().toISOString().split("T")[0];t.prepare("INSERT INTO comments (id,asset_id,user_id,user_name,user_avatar,content,rating,created_at,commenter_type) VALUES (?,?,?,?,?,?,?,?,?)").run(a,e.assetId,e.userId,e.userName,e.userAvatar,e.content,e.rating,r,e.commenterType??"user"),u(e.userId,"reputation",2,"write_comment",e.assetId),u(e.userId,"shrimp_coin",3,"write_comment",e.assetId);let s=t.prepare("SELECT author_id FROM assets WHERE id = ?").get(e.assetId);return s?.author_id&&s.author_id!==e.userId&&(e.rating>=4&&u(s.author_id,"reputation",5,"asset_rated_good",e.assetId),5===e.rating&&u(s.author_id,"shrimp_coin",15,"asset_rated_5star",e.assetId)),d(e.assetId),{id:a,...e,createdAt:r}}function K(e){return{id:e.id,assetId:e.asset_id,authorId:e.author_id,authorName:e.author_name,authorAvatar:e.author_avatar,authorType:e.author_type,title:e.title,body:e.body,status:e.status,labels:JSON.parse(e.labels),createdAt:e.created_at,commentCount:e.comment_count}}function J(e){return i().prepare("SELECT * FROM issues WHERE asset_id = ? ORDER BY created_at DESC").all(e).map(K)}function $(e){let t=i(),a="is-"+Math.random().toString(36).substring(2,8),r=new Date().toISOString().split("T")[0];return t.prepare("INSERT INTO issues (id,asset_id,author_id,author_name,author_avatar,author_type,title,body,status,labels,created_at,comment_count) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)").run(a,e.assetId,e.authorId,e.authorName,e.authorAvatar,e.authorType??"user",e.title,e.body,"open",JSON.stringify(e.labels??[]),r,0),u(e.authorId,"reputation",2,"submit_issue",e.assetId),u(e.authorId,"shrimp_coin",5,"submit_issue",e.assetId),{id:a,...e,status:"open",createdAt:r,commentCount:0}}function z(e){return i().prepare("SELECT * FROM issues WHERE title LIKE ? OR body LIKE ? ORDER BY created_at DESC").all(`%${e}%`,`%${e}%`).map(K)}function j(e){return{id:e.id,title:e.title,description:e.description,curatorId:e.curator_id,curatorName:e.curator_name,curatorAvatar:e.curator_avatar,assetIds:JSON.parse(e.asset_ids),coverEmoji:e.cover_emoji,followers:e.followers,createdAt:e.created_at}}function q(e){return i().prepare("SELECT * FROM collections WHERE title LIKE ? OR description LIKE ? ORDER BY followers DESC").all(`%${e}%`,`%${e}%`).map(j)}function V(e){return{id:e.id,type:e.type,title:e.title,message:e.message,icon:e.icon,linkTo:e.link_to??void 0,read:!!e.is_read,createdAt:e.created_at}}function Q(e="self"){return i().prepare("SELECT * FROM notifications WHERE user_id = ? ORDER BY created_at DESC").all(e).map(V)}function Z(e){i().prepare("UPDATE notifications SET is_read = 1 WHERE id = ?").run(e)}function ee(e="self"){i().prepare("UPDATE notifications SET is_read = 1 WHERE user_id = ?").run(e)}function et(e){return i().prepare("SELECT * FROM evolution_events WHERE user_id = ? ORDER BY date ASC").all(e).map(e=>({id:e.id,userId:e.user_id,icon:e.icon,title:e.title,description:e.description,date:e.date,type:e.type}))}function ea(e){return i().prepare("SELECT * FROM activity_events WHERE user_id = ? ORDER BY date DESC").all(e).map(e=>({id:e.id,userId:e.user_id,icon:e.icon,text:e.text,date:e.date,type:e.type,linkTo:e.link_to??void 0,actorType:e.actor_type}))}function er(){return i().prepare("SELECT * FROM daily_stats ORDER BY day ASC").all().map(e=>({day:e.day,downloads:e.downloads,newAssets:e.new_assets,newUsers:e.new_users}))}function es(){let e=i(),t=e.prepare("SELECT COUNT(*) as cnt FROM assets").get().cnt,a=e.prepare("SELECT COUNT(DISTINCT author_id) as cnt FROM assets WHERE author_id != ''").get().cnt,r=e.prepare("SELECT COALESCE(SUM(downloads), 0) as total FROM assets").get().total,s=new Date(Date.now()-6048e5).toISOString().split("T")[0],n=e.prepare("SELECT COUNT(*) as cnt FROM assets WHERE created_at >= ?").get(s).cnt;return{totalAssets:t,totalDevelopers:a,totalDownloads:r,weeklyNew:n,topDevelopers:e.prepare("SELECT author_id as id, author_name as name, author_avatar as avatar, COUNT(*) as assetCount, COALESCE(SUM(downloads),0) as totalDownloads FROM assets WHERE author_id != '' GROUP BY author_id ORDER BY totalDownloads DESC LIMIT 10").all(),recentActivity:e.prepare("SELECT name, display_name, author_name, author_avatar, version, created_at, updated_at FROM assets ORDER BY updated_at DESC LIMIT 20").all().map(e=>({type:e.created_at===e.updated_at?"publish":"update",authorName:e.author_name,authorAvatar:e.author_avatar,assetName:e.name,assetDisplayName:e.display_name,version:e.version,timestamp:e.updated_at}))}}function en(){let e=i().prepare("SELECT type, COUNT(*) as cnt FROM assets GROUP BY type").all(),t={};for(let a of e)t[a.type]=a.cnt;return t}function ei(){return i().prepare("SELECT COUNT(*) as cnt FROM comments").get().cnt}function eo(){return i().prepare("SELECT COUNT(*) as cnt FROM issues").get().cnt}function ed(e){let t,a=i(),r=[],s={};e.type&&["skill","config","plugin","trigger","channel","template"].includes(e.type)&&(r.push("type = @type"),s.type=e.type),e.category&&(r.push("category = @category"),s.category=e.category),e.tag&&(r.push("tags LIKE @tag"),s.tag=`%"${e.tag}"%`),e.q&&(r.push("(name LIKE @q OR display_name LIKE @q OR description LIKE @q OR tags LIKE @q)"),s.q=`%${e.q}%`);let n=r.length>0?"WHERE "+r.join(" AND "):"",o=a.prepare(`SELECT COUNT(*) as cnt FROM assets ${n}`).get(s).cnt;switch(e.sort){case"installs":case"downloads":t="downloads DESC";break;case"rating":t="rating DESC";break;case"newest":case"updated_at":t="updated_at DESC";break;case"created_at":t="created_at DESC";break;default:t="downloads DESC, updated_at DESC"}let d=Math.max(1,e.page??1),E=Math.min(100,Math.max(1,e.pageSize??20));return{assets:a.prepare(`SELECT id, name, display_name, type, description, tags, downloads, rating, author_name, author_id, version, install_command, updated_at, category FROM assets ${n} ORDER BY ${t} LIMIT @limit OFFSET @offset`).all({...s,limit:E,offset:(d-1)*E}).map(e=>({id:e.id,name:e.name,displayName:e.display_name,type:e.type,description:e.description,tags:JSON.parse(e.tags),installs:e.downloads,rating:e.rating,author:e.author_name,authorId:e.author_id,version:e.version,installCommand:e.install_command,updatedAt:e.updated_at,category:e.category})),total:o,page:d,pageSize:E}}function eE(){let e=i().prepare("SELECT tags FROM assets").all(),t=new Map;for(let a of e)for(let e of JSON.parse(a.tags))t.set(e,(t.get(e)??0)+1);return[...t.entries()].map(([e,t])=>({name:e,count:t})).sort((e,t)=>t.count-e.count)}function eu(){return i().prepare("SELECT category, COUNT(*) as cnt FROM assets WHERE category != '' GROUP BY category ORDER BY cnt DESC").all().map(e=>({name:e.category,count:e.cnt}))}function eT(e){let t=i().prepare("SELECT id, manifest FROM assets WHERE id = ?").get(e);return t?{id:t.id,manifest:JSON.parse(t.manifest||"{}")}:null}function ec(e,t){return i().prepare("UPDATE assets SET manifest = ? WHERE id = ?").run(JSON.stringify(t),e).changes>0}function ep(e){let t=i().prepare("SELECT name, display_name, readme, version FROM assets WHERE id = ?").get(e);return t?{name:t.name,displayName:t.display_name,readme:t.readme,version:t.version}:null}function el(e){if(0===e.length)return[];let t=i(),a=e.map(()=>"?").join(",");return t.prepare(`SELECT id, name, display_name, type, description, tags, downloads, rating, author_name, author_id, version, install_command, updated_at, category FROM assets WHERE id IN (${a})`).all(...e).map(e=>({id:e.id,name:e.name,displayName:e.display_name,type:e.type,description:e.description,tags:JSON.parse(e.tags),installs:e.downloads,rating:e.rating,author:e.author_name,authorId:e.author_id,version:e.version,installCommand:e.install_command,updatedAt:e.updated_at,category:e.category}))}function e_(e,t=10){return i().prepare("SELECT id, name, display_name, type, description, tags, downloads, rating, author_name, author_id, version, install_command, updated_at, category FROM assets ORDER BY downloads DESC, updated_at DESC LIMIT ?").all(Math.min(t,50)).map(e=>({id:e.id,name:e.name,displayName:e.display_name,type:e.type,description:e.description,tags:JSON.parse(e.tags),installs:e.downloads,rating:e.rating,author:e.author_name,authorId:e.author_id,version:e.version,installCommand:e.install_command,updatedAt:e.updated_at,category:e.category}))}e.s(["activateInviteCode",()=>h,"authorizeDevice",()=>b,"completeOnboarding",()=>y,"createAsset",()=>m,"createComment",()=>G,"createIssue",()=>$,"createSuperInviteCode",()=>f,"createUser",()=>R,"deleteAsset",()=>N,"deleteInviteCode",()=>F,"findUserById",()=>O,"findUserByProvider",()=>g,"getActivityEventsByUserId",()=>ea,"getAllCategories",()=>eu,"getAllTags",()=>eE,"getAssetById",()=>_,"getAssetCountByType",()=>en,"getAssetManifest",()=>eT,"getAssetReadme",()=>ep,"getAssetsByIds",()=>el,"getCoinHistory",()=>c,"getCommentsByAssetId",()=>k,"getEvolutionEventsByUserId",()=>et,"getGrowthData",()=>er,"getInviteCodeDetail",()=>D,"getIssuesByAssetId",()=>J,"getNotifications",()=>Q,"getStats",()=>es,"getTotalCommentCount",()=>ei,"getTotalIssueCount",()=>eo,"getTrendingAssets",()=>e_,"getUserCoins",()=>T,"getUserInviteCodes",()=>I,"getUserProfile",()=>W,"incrementDownload",()=>E,"listAllInviteCodes",()=>C,"listAssets",()=>l,"listAssetsCompact",()=>ed,"listAuthorizedDevices",()=>w,"listUserProfiles",()=>Y,"markAllRead",()=>ee,"markNotificationRead",()=>Z,"revokeDevice",()=>B,"searchCollections",()=>q,"searchIssues",()=>z,"searchUserProfiles",()=>x,"softDeleteUser",()=>S,"updateAsset",()=>L,"updateAssetManifest",()=>ec,"updateProviderInfo",()=>A,"userHasInviteAccess",()=>X,"validateDevice",()=>M,"validateInviteCode",()=>v],43793)}];

//# sourceMappingURL=src_lib_db_ts_86d9618b._.js.map